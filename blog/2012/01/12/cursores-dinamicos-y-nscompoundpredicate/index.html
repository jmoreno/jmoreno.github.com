<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Cursores Dinámicos Y NSCompoundPredicate</title>
  <meta name="description" content="En este blog encontraras cosas de iOS, Ruby on Rails, Padrino, reflexiones informáticas y hasta algo de bricolaje.
" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="canonical" href="http://javimoreno.me/blog/2012/01/12/cursores-dinamicos-y-nscompoundpredicate/">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
<!--  <link rel="stylesheet" href=""> -->
  <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
	
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38448478-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


	<link href='/stylesheets/all-5633615de6ceb2962f12411016b5b8ed.css' media='all' rel='stylesheet' type='text/css'>
</head>
  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<a href="http://javimoreno.me" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/df-logo.png)"></span></a>

<!-- header end -->
    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
						 
				    <h1 class="post-title">Cursores Dinámicos Y NSCompoundPredicate</h1>
						 
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person"></h4>
              on
              <time datetime="2012-01-12T03:02:00+01:00">12 Jan 2012</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>Hace unos años, en un proyecto lleno de anécdotas y experiencias, el grupo de desarrolladores me contaba que habían creado servicios para cada una de las tablas del modelo de datos con el objetivo de centralizar los accesos a la tablas. La idea me pareció interesante: estaba harto de tocar programas que tenían la misma query y había cambiado algún criterio por lo que unificar las consultas en un único servicio era genial.</p>

<p>Les sugerí que, a la hora de montar los cursores, preparasen toda salida de datos de forma que fuera reutilizable. De esta forma, a medida que se fueran creando nuevas consultas, solo habría que incluir la nueva query. “No habrá que dar de alta nuevas consultas, hacemos cursores dinámicos…” dijo uno de ellos con gran orgullo.</p>

<!--more-->

<p><em>CURSORES DINÁMICOS… Dios mío… se han atrevido a utilizar SQL dinámico, el mayor sacrilegio en cualquier instalación con un mainframe</em>, pensé yo. Cuando les dije que no se autorizaría la subida a producción de ningún programa con SQL dinámico me dijeron: “No, no. Si los hacemos con el SQL de toda la vida”.</p>

<p>Lo que hacían era montar el <em>where</em> de tal forma que incluían todos los campos por los que se podría preguntar y comprobaban si el campo de la tabla era igual a la variable o si la variable estaba vacía. Esto tenía dos resultados: con un único cursor se obtenían los mismo resultados que con cursores ad-hoc (menos código que picar) y al abrir el cursor, el DB2 hacía un TABLESPACE SCAN y el programa aparecía en todas las estadísticas de pésimo rendimiento (gran bronca del DBA).</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">PERSONAS</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="k">WHERE</span> <span class="p">(</span><span class="n">EDAD</span> <span class="o">=</span> <span class="p">:</span><span class="n">EDAD</span> <span class="k">OR</span> <span class="p">:</span><span class="n">EDAD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="k">AND</span> <span class="p">(</span><span class="n">SEXO</span> <span class="o">=</span> <span class="p">:</span><span class="n">SEXO</span> <span class="k">OR</span> <span class="p">:</span><span class="n">SEXO</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="k">AND</span> <span class="p">(</span><span class="n">ALTURA</span> <span class="o">=</span> <span class="p">:</span><span class="n">ALTURA</span> <span class="k">OR</span> <span class="p">:</span><span class="n">ALTURA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="k">AND</span> <span class="p">(</span><span class="n">PESO</span> <span class="o">=</span> <span class="p">:</span><span class="n">PESO</span> <span class="k">OR</span> <span class="p">:</span><span class="n">PESO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="k">AND</span> <span class="p">(</span><span class="n">COLOROJOS</span> <span class="o">=</span> <span class="p">:</span><span class="n">COLOROJOS</span> <span class="k">OR</span> <span class="p">:</span><span class="n">COLOROJOS</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="k">AND</span> <span class="p">(</span><span class="n">COLORPELO</span> <span class="o">=</span> <span class="p">:</span><span class="n">COLORPELO</span> <span class="k">OR</span> <span class="p">:</span><span class="n">COLORPELO</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">);</span></div></div></pre></div></figure>

<p>Por eso, cuando la semana pasada me empeñe en montar un predicado variable para un proyecto de iOS y termine encontrando NSCompoundPredicate, pensé: “Esto si que es un cursor dinámico”</p>

<p><strong>NSPredicate</strong> es una clase que se utiliza para definir condiciones lógicas que acoten una búsqueda. Esta clase se puede utilizar para obtener un array de objetos más pequeño a partir de otro más grande utilizando un método de la clase NSArray que es <em>filteredArrayUsingPredicate:</em></p>

<p>Por ejemplo: tenemos un array llamado <em>personas</em> que contiene objetos de tipo _Individuo. _El objeto individuo tiene diferentes propiedades: edad, sexo, altura, peso, colorOjos, colorPelo, etc. Si queremos tener un array más pequeño con las personas que son mujeres y tiene los ojos azules haríamos lo siguiente:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="bp">NSPredicate</span> <span class="o">*</span><span class="n">predicate</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSPredicate</span> <span class="nl">predicateWithFormat</span><span class="p">:</span><span class="s">@&quot;(sexo == %@ AND colorOjos == %@)&quot;</span><span class="p">,</span> <span class="n">individuo</span><span class="p">.</span><span class="n">sexo</span><span class="p">,</span> <span class="n">individuo</span><span class="p">.</span><span class="n">colorOjos</span><span class="p">];</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="bp">NSArray</span> <span class="o">*</span><span class="n">mujeresDeOjosAzules</span> <span class="o">=</span> <span class="p">[</span><span class="n">personas</span> <span class="nl">filteredArrayUsingPredicate</span><span class="p">:</span><span class="n">predicate</span><span class="p">];</span></div></div></pre></div></figure>

<p>En el ejemplo anterior, <em>individuo.sexo</em> contendría el valor “Mujer” e <em>individuo.colorOjos</em> contendría el valor “Azul”. Bastante fácil, no?.</p>

<p>Bueno, supongamos ahora que estamos montando una especie de “Quien es quien” en el que dejamos que pregunten de forma aleatoria por un campo, por dos, por todos, etc… pero sin ningún control. En este caso deberíamos evaluar todas las posibilidades y definir un NSPredicate para cada una de ellas, evaluando previamente cada situación.
Con pocas propiedades es asumible montar los diferentes NSPredicate, con seis propiedades las combinaciones van a ser unas cuantas (si mis recuerdos de combinatoria no fallan serían 63 combinaciones diferentes)… ¿tenemos que codificarlas todas? No, existe <strong>NSCompoundPredicate</strong>, la panacea de los cursores dinámicos.</p>

<p>El ejemplo quedaría así:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">predicateArray</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="p">(</span><span class="n">individuo</span><span class="p">.</span><span class="n">edad</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="p">[</span><span class="n">predicateArray</span> <span class="nl">addObject</span><span class="p">:[</span><span class="bp">NSPredicate</span> <span class="nl">predicateWithFormat</span><span class="p">:</span><span class="s">@&quot;(edad == %@)&quot;</span><span class="p">,</span> <span class="n">individuo</span><span class="p">.</span><span class="n">edad</span><span class="p">]];</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="p">(</span><span class="n">individuo</span><span class="p">.</span><span class="n">sexo</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="p">[</span><span class="n">predicateArray</span> <span class="nl">addObject</span><span class="p">:[</span><span class="bp">NSPredicate</span> <span class="nl">predicateWithFormat</span><span class="p">:</span><span class="s">@&quot;(sexo == %@)&quot;</span><span class="p">,</span> <span class="n">individuo</span><span class="p">.</span><span class="n">sexo</span><span class="p">]];</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="p">(</span><span class="n">individuo</span><span class="p">.</span><span class="n">altura</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="p">[</span><span class="n">predicateArray</span> <span class="nl">addObject</span><span class="p">:[</span><span class="bp">NSPredicate</span> <span class="nl">predicateWithFormat</span><span class="p">:</span><span class="s">@&quot;(altura == %@)&quot;</span><span class="p">,</span> <span class="n">individuo</span><span class="p">.</span><span class="n">altura</span><span class="p">]];</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="p">(</span><span class="n">individuo</span><span class="p">.</span><span class="n">peso</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="p">[</span><span class="n">predicateArray</span> <span class="nl">addObject</span><span class="p">:[</span><span class="bp">NSPredicate</span> <span class="nl">predicateWithFormat</span><span class="p">:</span><span class="s">@&quot;(peso == %@)&quot;</span><span class="p">,</span> <span class="n">individuo</span><span class="p">.</span><span class="n">peso</span><span class="p">]];</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="p">(</span><span class="n">individuo</span><span class="p">.</span><span class="n">colorOjos</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="p">[</span><span class="n">predicateArray</span> <span class="nl">addObject</span><span class="p">:[</span><span class="bp">NSPredicate</span> <span class="nl">predicateWithFormat</span><span class="p">:</span><span class="s">@&quot;(colorOjos == %@)&quot;</span><span class="p">,</span> <span class="n">individuo</span><span class="p">.</span><span class="n">colorOjos</span><span class="p">]];</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="p">(</span><span class="n">individuo</span><span class="p">.</span><span class="n">colorPelo</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">   <span class="p">[</span><span class="n">predicateArray</span> <span class="nl">addObject</span><span class="p">:[</span><span class="bp">NSPredicate</span> <span class="nl">predicateWithFormat</span><span class="p">:</span><span class="s">@&quot;(colorPelo == %@)&quot;</span><span class="p">,</span> <span class="n">individuo</span><span class="p">.</span><span class="n">colorPelo</span><span class="p">]];</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="bp">NSCompoundPredicate</span> <span class="o">*</span><span class="n">compoundPredicate</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSCompoundPredicate</span> <span class="nl">andPredicateWithSubpredicates</span><span class="p">:</span><span class="n">predicateArray</span><span class="p">];</span></div></div></pre></div></figure>

<p>Lo que hemos hecho es un NSPredicate por cada propiedad que tenemos que evaluar. Comprobando previamente que esa propiedad esté informada. Cada NSPredicate lo incluimos en un array que posteriormente le pasaremos a la clase NSCompoundPredicate a través del método correspondiente.
Esta clase solo posee tres métodos: andPredicateWithSubpredicates para recuperar los objetos que cumplan todas las condiciones, orPredicateWithSubpredicates para recuperar los objetos que cumplen alguna condición y notPredicateWithSubpredicates que, creo, sirve para recuperar los objetos que no cumplen ninguna condición.</p>

<p>Si queréis saber más sobre NSPredicate y NSCompoundPredicate, lo mejor es consultar la documentación de Apple:</p>

<p><a href="http://developer.apple.com/library/mac/#documentation/Cocoa/Reference/Foundation/Classes/NSPredicate_Class/Reference/NSPredicate.html">NSPredicate</a>
<a href="http://developer.apple.com/library/mac/#documentation/Cocoa/Reference/Foundation/Classes/NSCompoundPredicate_Class/Reference/Reference.html#//apple_ref/occ/cl/NSCompoundPredicate">NSCompoundPredicate</a></p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Cursores+Din%C3%A1micos+Y+NSCompoundPredicate&amp;url=http://javimoreno.me/blog/2012/01/12/cursores-dinamicos-y-nscompoundpredicate"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
					
				  <comments class="post-comments">
				    <div id="disqus_thread"></div>
    <script type="text/javascript">
    var disqus_shortname = 'eloctoblog';
    
      
      // var disqus_developer = 1;
      var disqus_identifier = 'http://javimoreno.me/blog/2012/01/12/cursores-dinamicos-y-nscompoundpredicate/';
      var disqus_url = 'http://javimoreno.me/blog/2012/01/12/cursores-dinamicos-y-nscompoundpredicate/';
      var disqus_script = 'embed.js';
    
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
				  </comments>
					
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4>Javi</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2012-01-12 03:02">12 Jan 2012</time></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Supported by</span></h5>
            <footer class="site-footer">
              <section class="poweredby">Proudly published with <a href="http://jekyllrb.com"> Jekyll</a></section>
              <a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> You should subscribe to my feed.</span></a>
              <div class="inner">
                <section class="copyright">All content copyright <a href="/">Javi</a> &copy; 2014<br>All rights reserved.</section>
              </div>
            </footer>
          </div>
        </div>
      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/cA4aKEIPQrerBnp1yGHv_IMG_9534-3-2.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">♟ Javi Moreno</h1>
        <h2 class="blog-description">En este blog encontraras cosas de iOS, Ruby on Rails, Padrino, reflexiones informáticas y hasta algo de bricolaje.
</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    $window.on('scroll', function() {
      var top = $window.scrollTop();

      if (top < 0 || top > 1500) { return; }
      $image
        .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
        .css('opacity', 1-Math.max(top/700, 0));
    });
    $window.trigger('scroll');

    var height = $('.article-image').height();
    $('.post-content').css('padding-top', height + 'px');

    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
       && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({ scrollTop: target.offset().top }, 500);
          return false;
        }
      }
    });
  });
}(jQuery));
</script>

  </body>
</html>