
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Helios II. Houston, tenemos un problema. - Javi Moreno</title>
  <meta name="author" content="Javi Moreno">

  
  <meta name="description" content="Segundo análisis de las funcionalidades del framework Helios, esta vez centrandome en las notificaciones Push">
  <meta name="keywords" content="Helios.io, Heroku, Houston, Orbiter, iOS, Notificaciones push, Ruby on Rails, AFNetworking">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://javimoreno.me/blog/2013/05/02/helios-ii-houston">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Javi Moreno" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Asap:400,700,700italic,400italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
<link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38448478-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Javi Moreno</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<ul class="social">

  <li><a rel="twitter" href="http://twitter.com/jmoreno78" title="Twitter">Twitter</a></li>


  <li><a rel="github" href="https://github.com/jmoreno" title="GitHub">GitHub</a></li>


  <li><a rel="email" href="mailto:javi@javimoreno.me" title="Email">Email</a></li>

</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:javimoreno.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/sobre-mi">Sobre mi</a></li>
  <li><a href="/proyectos">Proyectos</a></li>
  <li><a href="http://www.zinkinapps.com">Zink in apps!</a></li>
  <li><a href="/blog/archives">Archivo</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
		
			
		    <h1 class="entry-title">Helios II. Houston, tenemos un problema.</h1>
			
		
    
      <p class="meta">
        








  


<time datetime="2013-05-02T03:36:00+00:00" pubdate data-updated="true">May 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote><p>- Okay, Houston, we&#8217;ve had a problem here.<br/>- This is Houston. Say again, please!<br/>- Uh, Houston, we&#8217;ve had a problem.</p><footer><strong>CAPCOM Apollo XIII</strong> <cite>Jack Swigert - Jack R. Lousma - James a. Lovell.</cite></footer></blockquote>


<p>Aprovechando que Rafa Aguilar (aka <a href="http://twitter.com/rais38">@rais38</a>) ha publicado en <a href="http://objective-c.es">Objective-C.es</a> un par de entradas sobre las notificaciones Push en iOS he decidido aparcar un par de cosillas que me tenían bastante atareado y continuar con el análisis de <a href="http://helios.io">Helios.io</a> que había prometido.</p>

<!--more-->


<p>Yo no me voy a detener a explicar en que consisten las notificaciones Push y que tipos podemos encontrar en iOS ya que Rafa lo ha explicado estupendamente si no que voy a contar como se desarrollaría el ejemplo de la segunda entrada con Ruby en lugar de con PHP. Para ello, usaré Houston, una gema desarrollada por <a href="http://twitter.com/mattt">@mattt</a>. La versión actual de Helios (que tiene unas pocas horas) ya incluye Houston de serie así que Helios y Orbiter nos proporcionan un backend completo para el envío de notificaciones Push.</p>

<p>Os dejo los enlaces a los artículos de Rafa por si los queréis consultar antes de empezar:</p>

<p><a href="http://objective-c.es/envio-de-notificaciones-en-ios-parte-1/">Envío de notificaciones en iOS (Parte 1)</a></p>

<p><a href="http://objective-c.es/envio-de-notificaciones-en-ios-parte-2/">Envío de notificaciones en iOS (Parte 2)</a></p>

<h2>Helios y Orbiter. Preparando el CAPCOM.</h2>

<p>Si habéis seguido las indicaciones del artículo de Objective-C.es, tendréis una aplicación instalada en vuestro dispositivo que vuelca al log de Xcode el token que le devuelven los servidores de Apple para las notificaciones Push.
Helios y Orbiter nos proporcionan un sistema para almacenar esos tokens en un servidor, esto nos será útil cuando queramos enviar notificaciones desde nuestro servidor a los dispositivos que tengamos vinculados a nuestra aplicación. No será necesario pasar siempre el token al servicio si no que podría bastar con usar el <em>alias</em>.</p>

<p>Para ello, nos descargamos Orbiter de GitHub y lo incorporamos a nuestro proyecto o bien usamos CocoaPods, lo que hagamos habitualmente y modificamos el siguiente método del AppDelegate:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didRegisterForRemoteNotificationsWithDeviceToken:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">deviceToken</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">serverURL</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://192.168.1.105:3000&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSURLCredential</span> <span class="o">*</span><span class="n">serverCredential</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLCredential</span> <span class="nl">credentialWithUser:</span><span class="s">@&quot;YourUsername&quot;</span> <span class="nl">password:</span><span class="s">@&quot;YourPassword&quot;</span> <span class="nl">persistence:</span><span class="n">NSURLCredentialPersistencePermanent</span><span class="p">];</span>
</span><span class='line'>    <span class="n">Orbiter</span> <span class="o">*</span><span class="n">orbiter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Orbiter</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithBaseURL:</span><span class="n">serverURL</span> <span class="nl">credential:</span><span class="n">serverCredential</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">orbiter</span> <span class="nl">registerDeviceToken:</span><span class="n">deviceToken</span> <span class="nl">withAlias:</span><span class="s">@&quot;ApoloXIII&quot;</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Registration Success: %@&quot;</span><span class="p">,</span> <span class="n">responseObject</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Registration Error: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>El servidor que voy a utilizar para almacenar los tokens y enviar las notificaciones es el mismo de la entrada anterior sobre almacenamiento de datos y sincronización. Si recordáis, una de las cosas que hicimos fue poner seguridad por lo que necesitamos pasarle un usuario y una contraseña. Orbiter usa NSURLCredential para estos fines.</p>

<p>Si hemos hecho todo correctamente, al arrancar la aplicación en el dispositivo obtendremos el siguiente resultado:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>2013-05-01 11:07:01.903 CAPCOM<span class="o">[</span>24399:907<span class="o">]</span> Registration Success: <span class="o">{</span>
</span><span class='line'><span class="nv">device</span> <span class="o">=</span>     <span class="o">{</span>
</span><span class='line'>    <span class="nb">alias</span> <span class="o">=</span> ApoloXIII;
</span><span class='line'>    <span class="nv">badge</span> <span class="o">=</span> 0;
</span><span class='line'>    <span class="nv">id</span> <span class="o">=</span> 1;
</span><span class='line'>    <span class="s2">&quot;ip_address&quot;</span> <span class="o">=</span> <span class="s2">&quot;&lt;null&gt;&quot;</span>;
</span><span class='line'>    <span class="nv">language</span> <span class="o">=</span> es;
</span><span class='line'>    <span class="nv">lat</span> <span class="o">=</span> <span class="s2">&quot;&lt;null&gt;&quot;</span>;
</span><span class='line'>    <span class="nv">lng</span> <span class="o">=</span> <span class="s2">&quot;&lt;null&gt;&quot;</span>;
</span><span class='line'>    <span class="nv">locale</span> <span class="o">=</span> <span class="s2">&quot;es_ES&quot;</span>;
</span><span class='line'>    <span class="nv">tags</span> <span class="o">=</span>         <span class="o">(</span>
</span><span class='line'>        <span class="s2">&quot;iPhone OS 6.1.3&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;v1.0&quot;</span>,
</span><span class='line'>        iPhone
</span><span class='line'>    <span class="o">)</span>;
</span><span class='line'>    <span class="nv">timezone</span> <span class="o">=</span> <span class="s2">&quot;Europe/Madrid&quot;</span>;
</span><span class='line'>    <span class="nv">token</span> <span class="o">=</span> 1F0E7706D1A343BF17615051DB944743F18156C52EFF0F8DD43DDA23F156862A;
</span><span class='line'>    <span class="nv">tsv</span> <span class="o">=</span> <span class="s2">&quot;&#39;1f0e7706d1a343bf17615051db944743f18156c52eff0f8dd43dda23f156862a&#39;:1 &#39;apoloxiii&#39;:2 &#39;es&#39;:3,4 &#39;europe/madrid&#39;:5&quot;</span>;
</span><span class='line'>    <span class="o">}</span>;
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y en el panel de administración de Helios veremos lo siguiente:</p>

<p><img src="/images/photos/2013/admin-helios-tokens.png"></p>

<p>Ahora tenemos que preparar nuestro servidor para que realice el envío de notificaciones Push. Como ya hemos comentado al principio, esta funcionalidad no la traía Helios en su primera versión y nos obligaba a nosotros a incluir y configurar esta gema. Hace pocas horas han actualizado el repositorio de Helios incluyendo la funcionalidad de envío de mensajes mediante Houston. Como el merge en GitHub es tan reciente, la gema que hay en <a href="http://rubygems.org/gems/helios">RubyGems.org</a> todavía no está actualizada así que para poder usarla en nuestro proyecto Rails he tenido que indicar en el <em>gemfile</em> que tome el fuente de GitHub. Al hacerlo de esta forma, las dependencias no son visibles por el Bundler por lo que, para evitar errores, he indicado también que necesitamos la gema <strong>Houston</strong>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem <span class="s1">&#39;helios&#39;</span>, :git <span class="o">=</span>&gt; <span class="s1">&#39;git://github.com/helios-framework/helios.git&#39;</span>
</span><span class='line'>gem <span class="s1">&#39;houston&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahora tendremos que guardar el certificado para realizar APS en alguna carpeta de nuestro proyecto y decirle a Helios donde está. Los pasos que hay que seguir para trabajar con los certificados están en el post de Rafa, lo único que haremos diferente es el paso de exportación del certificado, al que le daremos un nombre más <em>comodo</em> para nuestra configuración:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>openssl pkcs12 -in CAPCOMAPNDEV.p12 -out apple_push_notification.pem -nodes -clcerts
</span></code></pre></td></tr></table></div></figure>


<p>El fichero .pem resultante lo dejaremos en la carpeta <em>config</em> de nuestro proyecto (junto al xcdatamodel) y modificaremos la configuración de Helios en nuestro <em>application.rb</em> de la siguiente manera:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Using framework Helios as a middleware for our app</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="ss">Helios</span><span class="p">:</span><span class="ss">:Application</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">service</span> <span class="ss">:data</span><span class="p">,</span> <span class="ss">model</span><span class="p">:</span> <span class="s1">&#39;./config/DealerErgoGo.xcdatamodel&#39;</span>
</span><span class='line'>  <span class="n">service</span> <span class="ss">:push_notification</span><span class="p">,</span> <span class="n">apn_certificate</span><span class="p">:</span> <span class="s1">&#39;.config/apple_push_notification.pem&#39;</span><span class="p">,</span> <span class="n">apn_environment</span><span class="p">:</span> <span class="s1">&#39;development&#39;</span>
</span><span class='line'>  <span class="n">service</span> <span class="ss">:in_app_purchase</span>
</span><span class='line'>  <span class="n">service</span> <span class="ss">:passbook</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Para comprobar que todo está bien configurado, ejecutamos la siguiente instrucción desde el terminal (recordad que nuestro servidor tiene configurado usuario y contraseña):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -X POST --user <span class="s2">&quot;username:password&quot;</span> -d <span class="s1">&#39;payload={&quot;aps&quot;: {&quot;alert&quot;:&quot;Okay, stand by Thirteen, we are looking at it.&quot;,&quot;badge&quot;:&quot;13&quot;,&quot;sound&quot;:&quot;default&quot;}}&#39;</span> http://localhost:3000/message
</span></code></pre></td></tr></table></div></figure>


<p>Listo, parece que ya tenemos comunicación con Houston&#8230; o por lo menos recibimos sus mensajes. ;-)</p>

<p><img src="/images/photos/2013/notificacion-iphone.png" width="320" height="480"></p>

<p>Houston incluye una utilidad de terminal a la que le pasamos un token, la ubicación del certificado y el mensaje que queremos enviar. Esto no verifica que hayamos configurado correctamente ningún servidor, solo que el certificado y el token sean correctos:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apn push <span class="s2">&quot;1F0E7706D1A343BF17615051DB944743F18156C52EFF0F8DD43DDA23F156862A&quot;</span> -c <span class="s2">&quot;config/apple_push_notification.pem&quot;</span> -m <span class="s2">&quot;Okay, stand by Thirteen, we&#39;re looking at it.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Siguientes pasos</h2>

<p>Nuevamente vuelvo a tener sentimientos encontrados. Aunque esta vez he terminado más satisfecho de forma general con los resultados obtenidos de Helios, Orbiter y Houston todavía queda mucho por hacer para tener algo que se parezca mínimamente a lo que nos ofrecen Parse o Urban Airship</p>

<p>Hemos almacenado los tokens en nuestro servidor y hemos sido capaces de enviar notificaciones a nuestro dispositivo desde el terminal. Podríamos realizar el envío de mensajes desde la propia aplicación con un método semejante a este:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">useHoustonServiceWithAlert:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">alert</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://localhost:3000&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">AFHTTPClient</span> <span class="o">*</span><span class="n">httpClient</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AFHTTPClient</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithBaseURL:</span><span class="n">url</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">httpClient</span> <span class="nl">setAuthorizationHeaderWithUsername:</span><span class="s">@&quot;GoogleReader&quot;</span> <span class="nl">password:</span><span class="s">@&quot;F0r3v3r&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;aps&quot;</span><span class="o">:</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;alert&quot;</span><span class="o">:</span> <span class="n">alert</span><span class="p">,</span> <span class="s">@&quot;sound&quot;</span><span class="o">:</span> <span class="s">@&quot;default&quot;</span><span class="p">}};</span>
</span><span class='line'>    <span class="n">NSData</span> <span class="o">*</span><span class="n">jsonData</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">dataWithJSONObject:</span><span class="n">payload</span>
</span><span class='line'>                                                       <span class="nl">options:</span><span class="mi">0</span>
</span><span class='line'>                                                         <span class="nl">error:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">JSONString</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithBytes:</span><span class="p">[</span><span class="n">jsonData</span> <span class="n">bytes</span><span class="p">]</span> <span class="nl">length:</span><span class="p">[</span><span class="n">jsonData</span> <span class="n">length</span><span class="p">]</span> <span class="nl">encoding:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span> <span class="nl">dictionaryWithObjectsAndKeys:</span>
</span><span class='line'>                            <span class="n">JSONString</span><span class="p">,</span> <span class="s">@&quot;payload&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">httpClient</span> <span class="nl">postPath:</span><span class="s">@&quot;/message&quot;</span> <span class="nl">parameters:</span><span class="n">params</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSString</span> <span class="o">*</span><span class="n">responseStr</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData:</span><span class="n">responseObject</span> <span class="nl">encoding:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Request Successful, response &#39;%@&#39;&quot;</span><span class="p">,</span> <span class="n">responseStr</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;[HTTPClient Error]: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pero en realidad este mensaje no se lo estaríamos enviando al Apolo XIII solamente si no a toda la misión Apolo. Si nos atrevemos a mirar el código fuente de Helios, el fichero <a href="https://github.com/helios-framework/helios/blob/master/lib/helios/backend/push-notification.rb"><em>push-notification.rb</em></a> es bastante clarificador: no solo admite el parámetro <em>payload</em>, también admite otro parámetro llamado <em>tokens</em> que es de tipo <em>array</em>. Es decir, si le pasamos un array de tokens el mensaje solo llegará a los dispositivos determinados por esos tokens.</p>

<p>Pero los tokens están almacenados en el servidor, hacemos el registro con Orbiter cada vez que un dispositivo en el que instalamos la aplicación acepta que le enviemos notificaciones Push. ¿Tenemos que descargarnos el listado completo de tokens al dispositivo y filtrar por los <em>alias</em>? Parece que no.</p>

<p>Si nos fijamos en el mismo fuente de antes, donde se define el método get devices, vemos que hay algunos parámetros que se le pueden pasar a dicho método: pages, per_page, limit, offset y q&#8230; los cuatro primeros son, obviamente, para controlar la paginación de los resultados y el quinto parece ser el indicado para hacer una <em>query</em> a la tabla <em>Device</em> pero, ¿qué es <a href="http://www.postgresql.org/docs/9.1/static/textsearch-tables.html"><em>tsquery</em></a>? Pues según la documentación de PostgreSQL es la forma de hacer búsqueda completa de texto dentro de una determinada entidad.</p>

<p>En realidad <em>tsquery</em> devolverá todas las registros en los que aparezca el <strong>lexema</strong> que estamos buscando, esto es, si queremos buscar el token del Apolo XIII haríamos una llamada como la siguiente:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -X GET --user <span class="s2">&quot;GoogleReader:F0r3v3r&quot;</span> http://localhost:3000/devices?q<span class="o">=</span>ApoloXIII
</span></code></pre></td></tr></table></div></figure>


<p>Pero si, por ejemplo, quisiéramos buscar el token del Apolo XI:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -X GET --user <span class="s2">&quot;GoogleReader:F0r3v3r&quot;</span> http://localhost:3000/devices?q<span class="o">=</span>ApoloXI
</span></code></pre></td></tr></table></div></figure>


<p>Recuperariamos los tokens de los Apolos XI, XII, XIII y XIV. Es más, como la búsqueda se hace en todos los campos de la entidad Device, pudiera ser que recuperáramos algún otro registro más. Por ejemplo, si en vez de misiones espaciales utilizáramos como <em>alias</em> los nombres de las lunas de Jupiter. Al buscar el token de <em>Europe</em>, la consulta nos devolvería el token del alias <em>Europe</em> y el de todos los registros de dispositivos con <em>timezone</em> europeo.</p>

<p>Para este caso particular, y viendo el funcionamiento de los servicios de Parse y Urban Airship, sería conveniente ampliar las funcionalidades de push-notification.rb para incluir los alias como parámetro y buscar sus tokens. Además sería conveniente hacer el envío de notificaciones en batch para los casos en los que hubiera muchos tokens. Sería recomendable que las notificaciones se almacenaran en base de datos y que el envío se hiciera en background&#8230; vamos, que esto es un no parar. :-)</p>

<p>Aun con todo el trabajo que queda por hacer, hemos podido ver lo sencillo que es montar un sistema de notificaciones para nuestras aplicaciones iOS. Si solo lo queremos para enviar, de vez en cuando, un mensajero para que nos compren alguna aplicación, con esto tenemos más que suficiente.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Javi Moreno</span></span>

      








  


<time datetime="2013-05-02T03:36:00+00:00" pubdate data-updated="true">May 2<span>nd</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/análisis/'>Análisis</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <div class="kcy_karmacracy_widget_h_ID" style="display:inline"></div>
  
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://javimoreno.me/blog/2013/05/02/helios-ii-houston/" data-via="jmoreno78" data-counturl="http://javimoreno.me/blog/2013/05/02/helios-ii-houston/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/04/11/helios-i-guardando-datos/" title="Previous Post: Helios I. Guardando datos">&laquo; Helios I. Guardando datos</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/05/17/sobre-memorion/" title="Next Post: Sobre Memorión">Sobre Memorión &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Javi Moreno -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'eloctoblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://javimoreno.me/blog/2013/05/02/helios-ii-houston/';
        var disqus_url = 'http://javimoreno.me/blog/2013/05/02/helios-ii-houston/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  
  <script defer="defer" src="http://rodney.karmacracy.com/widget-3.0/?id=ID&button=1&display=right&show-tooltip=0"></script>
  




</body>
</html>
