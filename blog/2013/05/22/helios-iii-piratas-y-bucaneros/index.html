<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Helios III. Piratas Y Bucaneros.</title>
    <meta name="description" content="En este blog encontraras cosas de iOS, Ruby on Rails, Padrino, reflexiones informáticas y hasta algo de bricolaje.
">

    <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
    <link href='http://fonts.googleapis.com/css?family=Sanchez:400italic,400' rel='stylesheet' type='text/css'>
    <link href="http://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://javimoreno.me/blog/2013/05/22/helios-iii-piratas-y-bucaneros/">
	  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38448478-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

	<link href='/stylesheets/all-5633615de6ceb2962f12411016b5b8ed.css' media='all' rel='stylesheet' type='text/css'>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">♟ Javi Moreno</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
          <a class="page-link" href="/about.html">Sobre Mi</a>
          
        
          
          <a class="page-link" href="/articles/">Artículos</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/linkposts/">Enlaces</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
		 
    <h1 class="post-title">Helios III. Piratas Y Bucaneros.</h1>
		 
		
    <p class="post-meta">May 22, 2013 · 12 minutos</p>
  </header>

  <article class="post-content">
    <figure class="quote"><blockquote><p>El puerto espacial de Mos Eisley. No encontrarás nunca un lugar como éste tan lleno de maldad y vileza. Debemos cuidarnos.</p></blockquote><figcaption class="quote-source"><span class="quote-author">Star Wars</span><cite class="quote-title">Ben Kenobi llegando a Mos Eisley con Luke Skywalker</cite></figcaption></figure>

<p>Para esta tercera entrega volvemos a basarnos en unos artículos de Rafa Aguilar (aka <a href="http://twitter.com/rais38">@rais38</a>), recien publicados en <a href="http://objective-c.es">Objective-C.es</a>, donde primero nos explica las <a href="http://objective-c.es/in-app-purchases-en-ios-parte-1/">categorías y tipos de In-App Purchases</a> y después <a href="http://objective-c.es/in-app-purchases-en-ios-parte-2/">nos enseña con un ejemplo</a> lo sencillo que es incorporar a una aplicación esta excelente fuente de ingresos.    <br />
Nosotros aquí vamos a ver como simplifica CargoBay el uso de IAP en nuestras aplicaciones y también a verificar si la compra se ha realizado correctamente por el método más seguro: un servidor con Helios.</p>

<!--more-->

<p>He de reconocer que a medida que he ido avanzando en el análisis de Helios he ido apreciando la bien que esta planteado y lo que puede suponer para un desarrollador que se quiera aventurar en la creación de su propio backend. Cierto es que la primera parte, la que replica el modelo Core Data en el servidor me parece que está todavía un poco floja, así como la sincronización entre los dispositivos y el backend. El soporte para notificaciones push está bien, todavía le queda camino que recorrer pero es un buen punto de partida si quieres tener tu propio gestor de notificaciones. Pero con CargoBay y Venice, la gestión de las compras dentro de la aplicación se simplifican una barbaridad. </p>

<p>CargoBay es una pequeña librería de Mattt Thompson (del que no hemos hablado prácticamente nada en este blog) que facilita la gestión de estas transacciones al reducir a unos pocos métodos con bloques la recuperación de productos, comprobación del estado de la compra así como la verificación del recibo siguiendo las recomendaciones de Apple para evitar los fraudes en este tipo de compras. </p>

<p>Venice, es la gema que incluye Helios para realizar la verificación del recibo en servidor (otra recomendación de Apple para evitar fraudes). La otra funcionalidad que ofrece esta gema es devolver un listado de identificadores de IAP, esto será muy útil cuando queramos cambiar la oferta de productos en nuestra aplicación sin tener que actualizar la aplicación vía iTunes Connect. Para poder utilizar esta funcionalidad, nuestra aplicación debe estar preparada para trabajar con todos los productos que le vayan a llegar por este servicio.</p>

<p>Con todo lo que ya sabemos gracias a Rafa, vamos a crear una aplicación que nos permita contratar los servicios de los piratas y cazarecompensas que habitan Mos Eisley. Sabemos que nadie es de fiar en este lugar así que mejor que incluyamos un sistema de verificación de las compras o nuestro jefe nos terminará dando de comer a un sarlacc (algo muy doloroso ya que recordemos que su digestión dura más de mil años).</p>

<p>Para probar algunas bondades de CargoBay vamos a hacer lo siguiente: En iTunes Connect vamos a crear las siguientes IAP tal y como nos ha <a href="">contado Rafa</a>:</p>

<table>
  <thead>
    <tr>
      <th>Producto</th>
      <th>Identificador</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Han Solo</td>
      <td>com.cytdevteam.MosEisley.HanSolo</td>
    </tr>
    <tr>
      <td>Chewbacca</td>
      <td>com.cytdevteam.MosEisley.Chewbacca</td>
    </tr>
    <tr>
      <td>Millennium Falcon</td>
      <td>com.cytdevteam.MosEisley.MillenniumFalcon</td>
    </tr>
    <tr>
      <td>Modal Nodes</td>
      <td>com.cytdevteam.MosEisley.ModalNodes</td>
    </tr>
  </tbody>
</table>

<p>En nuestro repositorio de productos de Helios vamos a crear estos cuatro productos y dos más:      </p>

<table>
  <thead>
    <tr>
      <th>Producto</th>
      <th>Identificador</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Han Solo</td>
      <td>com.cytdevteam.MosEisley.HanSolo</td>
    </tr>
    <tr>
      <td>Chewbacca</td>
      <td>com.cytdevteam.MosEisley.Chewbacca</td>
    </tr>
    <tr>
      <td>Millennium Falcon</td>
      <td>com.cytdevteam.MosEisley.MillenniumFalcon</td>
    </tr>
    <tr>
      <td>Modal Nodes</td>
      <td>com.cytdevteam.MosEisley.ModalNodes</td>
    </tr>
    <tr>
      <td>Greedo</td>
      <td>com.cytdevteam.MosEisley.Greedo</td>
    </tr>
    <tr>
      <td>Boba Fett</td>
      <td>com.cytdevteam.MosEisley.BobaFett</td>
    </tr>
  </tbody>
</table>

<p>Si echamos un vistazo a la documentación de Helios, veremos que los únicos métodos que ofrece para In-App Purchases son un GET de productos y un POST para comprobar recibos… ¿Cómo grabamos entonces los productos en la tabla? pues como graban los hombres, con SQL directamente sobre la base de datos.</p>

<p>Creamos un nuevo fichero <em>HeliosTasks.rake</em> en nuestro proyecto para poder lanzarlo tanto en local como en servidor de forma manual y escribimos lo siguiente:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">namespace</span> <span class="ss">:HeliosTasks</span> <span class="k">do</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">desc</span> <span class="s2">&quot;TODO&quot;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">task</span> <span class="ss">:loadIdentifiers</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nb">require</span> <span class="s1">&#39;pg&#39;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="no">PGconn</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">5432</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span> 
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">end</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">populate_products</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM in_app_purchase_products;  -- empty contents of table</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">                           VALUES (1, &#39;com.cytdevteam.MosEisley.HanSolo&#39;, &#39;Consumable&#39;, &#39;Han Solo&#39;, &#39;Han Solo The One And Only&#39;, 0.99, &#39;USD&#39;, &#39;t&#39;);</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">                           VALUES (2, &#39;com.cytdevteam.MosEisley.Chewbacca&#39;, &#39;Consumable&#39;, &#39;Chewbacca&#39;, &#39;Chewbacca&#39;, 0.99, &#39;USD&#39;, &#39;t&#39;);</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">                           VALUES (3, &#39;com.cytdevteam.MosEisley.MillenniumFalcon&#39;, &#39;Consumable&#39;, &#39;Millennium Falcon&#39;, &#39;Millennium Falcon&#39;, 4.99, &#39;USD&#39;, &#39;t&#39;);</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">                           VALUES (4, &#39;com.cytdevteam.MosEisley.ModalNodes&#39;, &#39;Consumable&#39;, &#39;Modal Nodes&#39;, &#39;A real Modal Nodes` gig&#39;, 4.99, &#39;USD&#39;, &#39;t&#39;);</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">                           VALUES (5, &#39;com.cytdevteam.MosEisley.Greedo&#39;, &#39;Consumable&#39;, &#39;Greedo&#39;, &#39;A coward that shot first&#39;, 4.99, &#39;USD&#39;, &#39;t&#39;);</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s2">                           VALUES (6, &#39;com.cytdevteam.MosEisley.BobaFett&#39;, &#39;Consumable&#39;, &#39;Boba Fett&#39;, &#39;He is no good to me dead&#39;, 4.99, &#39;USD&#39;, &#39;t&#39;);&quot;</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">conn</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">end</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">begin</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="s1">&#39;databaseName&#39;</span><span class="p">,</span><span class="s1">&#39;username&#39;</span><span class="p">,</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="nb">puts</span> <span class="s2">&quot;Connected to </span><span class="si">#&#x7b;</span><span class="n">conn</span><span class="o">.</span><span class="n">db</span><span class="si">&#x7d;</span><span class="s2"> at </span><span class="si">#&#x7b;</span><span class="n">conn</span><span class="o">.</span><span class="n">host</span><span class="si">&#x7d;</span><span class="s2">&quot;</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">populate_products</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>  
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">rescue</span> <span class="no">PGError</span><span class="o">=&gt;</span><span class="n">e</span> 
</div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="nb">puts</span> <span class="s2">&quot;Oh Oh!&quot;</span><span class="p">,</span> <span class="n">e</span>
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">ensure</span>
</div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">conn</span><span class="o">.</span><span class="n">close</span> <span class="k">unless</span> <span class="n">conn</span><span class="o">.</span><span class="n">nil?</span>
</div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="nb">puts</span> <span class="s2">&quot;Connection closed&quot;</span> 
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">end</span>
</div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="k">end</span>
</div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">end</span></div></div></pre></div></figure>

<p>No creo que os cueste mucho ver lo que hace: establece una conexión con la base de datos y a continuación borra e inserta seis registros. Si hubiera algún error saldría por la consola.</p>

<p>Si ahora escribimos en un navegador <a href="http://localhost:3000/products/identifiers">http://localhost:3000/products/identifiers</a></p>

<p>veríamos algo como esto:</p>

<p><img src="http://javimoreno.me/assets/photos/2013/jsonResponse.png" alt="" /></p>

<p>Ya hemos creado todas las IAP en iTunes Connect (que coñazo) y hemos insertado los productos que vamos a ofrecer en nuestro servidor. Es el momento de liarnos la manta a la cabeza con la aplicación.</p>

<p>Nos vamos a basar en la plantilla de Master-Detail con ARC, Storyboards y Core Data. La primera lista serán las compras que hayamos realizado. En Storyboard añadiremos un nuevo navigation controller con un UITableViewController donde mostraremos los productos que se pueden comprar a través del App Store. </p>

<p>Si a estas alturas todavía no usas CocoaPods deberías hacerlo, es la forma más fácil de gestionar las librerías de terceros que usas en tus aplicaciones. En este caso, nuestro podfile incluirá AFNetworking, CargoBay y NSData+Base64:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">platform :ios, '5.0'
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">pod 'AFNetworking', '~&gt; 1.2'
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">pod 'CargoBay', '~&gt; 0.3.2'
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">pod 'NSData+Base64', '~&gt; 1.0.0'</div></div></pre></div></figure>

<h2 id="un-pequeo-expositor">Un pequeño expositor.</h2>

<p>Ya sabemos que lo primero que hay que hacer es comprobar si nuestra aplicación tiene permiso para hacer compras dentro de la aplicación. En caso afirmativo podremos acceder a nuestros servidores para recuperar la información de los productos que tenemos a la venta:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c1">// Comprobamos si hay alguna restricción configurada en el device respecto a las In-App Purchases.</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="p">([</span><span class="bp">SKPaymentQueue</span> <span class="n">canMakePayments</span><span class="p">])</span> <span class="p">&#x7b;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Puedo hacer pagos In-App&quot;</span><span class="p">);</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">[</span><span class="nb">self</span> <span class="n">getProductsInStoreKitDirectlyFromHelios</span><span class="p">];</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">else</span> <span class="p">&#x7b;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Control parental activado&quot;</span><span class="p">);</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>Para cargar el UITableView del viewController de productos necesitamos un array de productos. Toda la información del producto tal y como está en iTunes Connect la podemos obtener a través de StoreKit pero CargoBay nos proporciona unos métodos con bloques que recuperan está información. Podemos hacerlo de dos formas: recuperando primero la lista de identificadores y después pasándole esta lista al método correspondiente:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getProductsIdentifiersInHelios</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="s">@&quot;http://localhost:3000/products/identifiers/&quot;</span><span class="p">];</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLRequest</span> <span class="nl">requestWithURL</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[</span><span class="n">AFJSONRequestOperation</span> <span class="nl">JSONRequestOperationWithRequest</span><span class="p">:</span><span class="n">request</span> <span class="nl">success</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSURLRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="bp">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="kt">id</span> <span class="n">JSON</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">[</span><span class="nb">self</span> <span class="nl">getProductsInStoreKitFromArray</span><span class="p">:</span><span class="n">JSON</span><span class="p">];</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;</span> <span class="nl">failure</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSURLRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="bp">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="kt">id</span> <span class="n">JSON</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">description</span><span class="p">]);</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;];</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getProductsInStoreKitFromArray:</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">array</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="nl">productsWithIdentifiers</span><span class="p">:[</span><span class="bp">NSSet</span> <span class="nl">setWithArray</span><span class="p">:</span><span class="n">array</span><span class="p">]</span> <span class="nl">success</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="n">products</span><span class="p">,</span> <span class="bp">NSArray</span> <span class="o">*</span><span class="n">invalidIdentifiers</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_productsArray</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">_productsArray</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSMutableArray</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithCapacity</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">&#x7d;</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Products: %@&quot;</span><span class="p">,</span> <span class="n">products</span><span class="p">);</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Invalid Identifiers: %@&quot;</span><span class="p">,</span> <span class="n">invalidIdentifiers</span><span class="p">);</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">_productsArray</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="nl">arrayWithArray</span><span class="p">:</span><span class="n">products</span><span class="p">];</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;</span> <span class="nl">failure</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;];</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>O bien, si tenemos la certeza que el servicio ya nos devuelve los datos en una array únicamente con los identificadores (que es como espera CargoBay que se lo pasemos), podemos hacerlo todo en un único método:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getProductsInStoreKitDirectlyFromHelios</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="s">@&quot;http://localhost:3000/products/identifiers/&quot;</span><span class="p">];</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLRequest</span> <span class="nl">requestWithURL</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="nl">productsWithRequest</span><span class="p">:</span><span class="n">request</span> <span class="nl">success</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">*</span><span class="n">products</span><span class="p">,</span> <span class="bp">NSArray</span> <span class="o">*</span><span class="n">invalidIdentifiers</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Products: %@&quot;</span><span class="p">,</span> <span class="n">products</span><span class="p">);</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Invalid Identifiers: %@&quot;</span><span class="p">,</span> <span class="n">invalidIdentifiers</span><span class="p">);</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">_productsArray</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="nl">arrayWithArray</span><span class="p">:</span><span class="n">products</span><span class="p">];</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;</span> <span class="nl">failure</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">description</span><span class="p">]);</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;];</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>En cualquiera de los dos casos, el resultado del log será el siguiente:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">2013-05-15 16:14:48.275 MosEisley[3242:c07] Products: (
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">    "&lt;SKProduct: 0x77ad230&gt;",
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    "&lt;SKProduct: 0x82a5ab0&gt;",
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    "&lt;SKProduct: 0x8267f70&gt;",
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    "&lt;SKProduct: 0x8263400&gt;"
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">)
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">2013-05-15 16:14:48.275 MosEisley[3242:c07] Invalid Identifiers: (
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    "com.cytdevteam.MosEisley.Greedo",
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">    "com.cytdevteam.MosEisley.BobaFett"
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">)</div></div></pre></div></figure>

<p>Es decir, hemos recuperado seis registros de nuestro servidor de los cuales cuatro son productos correctos en iTunes Connect y dos no lo son. Solo mostraremos los productos correctos:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="cp">#pragma mark - Table view data source</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="o">-</span> <span class="p">(</span><span class="bp">NSInteger</span><span class="p">)</span><span class="nl">numberOfSectionsInTableView</span><span class="p">:(</span><span class="bp">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">&#x7b;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="c1">// Return the number of sections.</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">&#x7d;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="o">-</span> <span class="p">(</span><span class="bp">NSInteger</span><span class="p">)</span><span class="nl">tableView</span><span class="p">:(</span><span class="bp">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span> <span class="nl">numberOfRowsInSection</span><span class="p">:(</span><span class="bp">NSInteger</span><span class="p">)</span><span class="n">section</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">&#x7b;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="c1">// Return the number of rows in the section.</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="k">return</span> <span class="p">[</span><span class="n">_productsArray</span> <span class="n">count</span><span class="p">];</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">&#x7d;</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="o">-</span> <span class="p">(</span><span class="bp">UITableViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nl">tableView</span><span class="p">:(</span><span class="bp">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span> <span class="nl">cellForRowAtIndexPath</span><span class="p">:(</span><span class="bp">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="n">indexPath</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">&#x7b;</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="k">static</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">CellIdentifier</span> <span class="o">=</span> <span class="s">@&quot;Cell&quot;</span><span class="p">;</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="bp">UITableViewCell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">tableView</span> <span class="nl">dequeueReusableCellWithIdentifier</span><span class="p">:</span><span class="n">CellIdentifier</span> <span class="nl">forIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">];</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="c1">// Configure the cell...</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="bp">SKProduct</span> <span class="o">*</span><span class="n">product</span> <span class="o">=</span> <span class="p">[</span><span class="n">_productsArray</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">];</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="p">.</span><span class="n">localizedTitle</span><span class="p">;</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="n">cell</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">;</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="k">return</span> <span class="n">cell</span><span class="p">;</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>Esta será, más o menos, la imagen de nuestro expositor:</p>

<p><img src="http://javimoreno.me/assets/photos/2013/productsViewController.png" alt="" /></p>

<p>Para realizar las compras, CargoBay no tiene ninguna utilidad desarrollada por el momento, la única diferencia con el tutorial de Rafa es que el observer no es necesario incluirlo aquí ya que lo vamos a hacer en el <code>(BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions</code> para que gestiones no solo estas compras si no también las compras que pudieran haber quedado pendientes al cerrar la aplicación:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="cp">#pragma mark - Table view delegate</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">tableView</span><span class="p">:(</span><span class="bp">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span> <span class="nl">didSelectRowAtIndexPath</span><span class="p">:(</span><span class="bp">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="n">indexPath</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">&#x7b;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="c1">// Añadimos el producto que recibimos en el método delegado productsRequest:didReceiveResponse:</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="bp">SKPayment</span> <span class="o">*</span><span class="n">pago</span> <span class="o">=</span> <span class="p">[</span><span class="bp">SKPayment</span> <span class="nl">paymentWithProduct</span><span class="p">:[</span><span class="n">_productsArray</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">]];</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="c1">// Nos añadimos a nosotros mismos como observadores de la transacción.</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="c1">//    [[SKPaymentQueue defaultQueue] addTransactionObserver:self];</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">     <span class="p">[[</span><span class="bp">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">addPayment</span><span class="p">:</span><span class="n">pago</span><span class="p">];</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"> <span class="p">&#x7d;</span></div></div></pre></div></figure>

<h2 id="que-no-se-pierda-ni-un-recibo">Que no se pierda ni un recibo.</h2>

<p>Tal y como acabamos de comentar, el <em>observer</em> de la cola de pagos lo vamos a incluir en <code>(BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions</code> para que no se pierda ni una sola operación. Además incluimos el bloque que se llamará cada vez que haya alguna actualización de una transacción:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="bp">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c1">// Payment Queue Observation with CargoBay</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="nl">setPaymentQueueUpdatedTransactionsBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">SKPaymentQueue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="bp">NSArray</span> <span class="o">*</span><span class="n">transactions</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Updated Transactions: %@&quot;</span><span class="p">,</span> <span class="n">transactions</span><span class="p">);</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">for</span> <span class="p">(</span><span class="bp">SKPaymentTransaction</span> <span class="o">*</span><span class="n">transaction</span> <span class="k">in</span> <span class="n">transactions</span><span class="p">)</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">&#x7b;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">switch</span> <span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">transactionState</span><span class="p">)</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="p">&#x7b;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">                <span class="k">case</span> <span class="nl">SKPaymentTransactionStatePurchased</span><span class="p">:</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">                    <span class="p">[</span><span class="nb">self</span> <span class="nl">oneStepVerification</span><span class="p">:</span><span class="n">transaction</span><span class="p">];</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">                    <span class="k">break</span><span class="p">;</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">                <span class="k">case</span> <span class="nl">SKPaymentTransactionStateFailed</span><span class="p">:</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">                         <span class="c1">// TODO</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">                    <span class="k">break</span><span class="p">;</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">                <span class="k">case</span> <span class="nl">SKPaymentTransactionStateRestored</span><span class="p">:</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">                         <span class="c1">// TODO</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">                    <span class="k">break</span><span class="p">;</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">                <span class="k">default</span><span class="o">:</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">                    <span class="k">break</span><span class="p">;</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="p">&#x7d;</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">&#x7d;</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;];</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[[</span><span class="bp">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">addTransactionObserver</span><span class="p">:[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]];</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c1">// Override point for customization after application launch.</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">...</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>Cuando la transacción pase a un estado de <em>purchased</em> es cuando deberemos realizar las acciones derivadas de la compra, antes de hacer nada es cuando deberíamos asegurarnos de que el recibo es verdadero. Las dos opciones que tenemos son verificar dentro de la propia aplicación accediendo a un servicio de Apple o llamar a un servicio nuestro que realice ese mismo acceso. Para el primer caso, CargoBay ya nos proporciona un método que realiza esa verificación:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">oneStepVerification:</span><span class="p">(</span><span class="bp">SKPaymentTransaction</span> <span class="o">*</span><span class="p">)</span><span class="nv">transaction</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="nl">verifyTransaction</span><span class="p">:</span><span class="n">transaction</span> <span class="nl">password</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">success</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">receipt</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Receipt: %@&quot;</span><span class="p">,</span> <span class="n">receipt</span><span class="p">);</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">[</span><span class="nb">self</span> <span class="nl">serverSideVerification</span><span class="p">:</span><span class="n">transaction</span><span class="p">];</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;</span> <span class="nl">failure</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error %d (%@)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">code</span><span class="p">],</span> <span class="p">[</span><span class="n">error</span> <span class="n">localizedDescription</span><span class="p">]);</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;];</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>Es de sobra conocido que tanto las IAP son fácilmente <em>pirateables</em> y aunque la verificación desde la propia aplicación aumenta la seguridad de nuestras ventas, también son conocidos los casos en los que esta verificación también ha sido <em>hackeada</em>. La otra utilidad de Venice es la realización de esta misma verificación en nuestro servidor:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">serverSideVerification:</span><span class="p">(</span><span class="bp">SKPaymentTransaction</span> <span class="o">*</span><span class="p">)</span><span class="nv">transaction</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="s">@&quot;http://localhost:3000/receipts/verify&quot;</span><span class="p">];</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSMutableURLRequest</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[</span><span class="n">request</span> <span class="nl">setHTTPMethod</span><span class="p">:</span><span class="s">@&quot;POST&quot;</span><span class="p">];</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">paths</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">);</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSString</span> <span class="o">*</span><span class="n">documentsDirectory</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSString</span> <span class="o">*</span><span class="n">appFile</span> <span class="o">=</span> <span class="p">[</span><span class="n">documentsDirectory</span> <span class="nl">stringByAppendingPathComponent</span><span class="p">:</span><span class="s">@&quot;TransactionReceipt&quot;</span><span class="p">];</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[</span><span class="n">transaction</span><span class="p">.</span><span class="n">transactionReceipt</span> <span class="nl">writeToFile</span><span class="p">:</span><span class="n">appFile</span> <span class="nl">atomically</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSString</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;receipt-data=%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">transaction</span><span class="p">.</span><span class="n">transactionReceipt</span> <span class="n">base64EncodedString</span><span class="p">]];</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="bp">NSData</span> <span class="o">*</span><span class="n">httpBody</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[</span><span class="n">request</span> <span class="nl">setHTTPBody</span><span class="p">:</span><span class="n">httpBody</span><span class="p">];</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">[</span><span class="bp">NSURLConnection</span> <span class="nl">sendAsynchronousRequest</span><span class="p">:</span><span class="n">request</span> <span class="nl">queue</span><span class="p">:[</span><span class="bp">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">]</span> <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="bp">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">httpResponse</span> <span class="o">=</span> <span class="p">(</span><span class="bp">NSHTTPURLResponse</span> <span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="p">;</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="p">(</span><span class="n">httpResponse</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">==</span> <span class="mi">200</span> <span class="o">||</span> <span class="n">httpResponse</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">==</span> <span class="mi">203</span><span class="p">)</span> <span class="p">&#x7b;</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="kt">id</span> <span class="n">receipt</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSJSONSerialization</span> <span class="nl">JSONObjectWithData</span><span class="p">:</span><span class="n">data</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">                                                         <span class="nl">options</span><span class="p">:</span><span class="mi">0</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">                                                           <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Received receipt: %@&quot;</span><span class="p">,</span> <span class="n">receipt</span><span class="p">);</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="p">[[</span><span class="bp">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">finishTransaction</span><span class="p">:</span> <span class="n">transaction</span><span class="p">];</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">&#x7d;</span> <span class="k">else</span> <span class="p">&#x7b;</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Body: %@&quot;</span><span class="p">,</span> <span class="p">[[</span><span class="bp">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData</span><span class="p">:</span><span class="n">data</span> <span class="nl">encoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]);</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;ERROR: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">&#x7d;</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;];</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>En el ejemplo de nuestra aplicación realizamos primero la verificación desde nuestra aplicación y posteriormente nos aseguramos repitiendo la verificación en nuestro servidor. Quizá sería más práctico hacerlo al revés: primero en nuestro servidor y si, por algún motivo, no hemos podido realizar la verificación hacerla desde nuestra aplicación como segunda opción.</p>

<p>Ah, podemos dormir tranquilos. La verificación desde nuestro servidor deja registro para que podamos hacernos una idea del volumen de nuestras compras… y a lo mejor sorprender a algún tunante:</p>

<p><img src="http://javimoreno.me/assets/photos/2013/helios-panel-admin.png" alt="" /></p>

<p>A partir de aquí, si la compra ha sido correcta, podemos insertar el registro en nuestra base de datos que le informa a la aplicación que la compra ha sido registrada con éxito. En el ejemplo de Rafa, en este momento habría que descargar la canción.</p>

<p>Por esta vez nada más, si habéis leído los anteriores notaréis que esta vez estoy más entusiasmado con la funcionalidad de Helios. No me he pegado mucho con StoreKit, tan solo con la versión pro de una aplicación, pero la verdad es que ahora si que tengo claro que usaré CargoBay y con toda seguridad haré la verificación en servidor con Venice… aunque haya que tocar algo el código base.</p>

<blockquote>
  <p>Ojito con las dependencias. No se que versión de Helios, CargoBay y AFNetworking estaréis utilizando pero se nota que estos frameworks se están tocando bastante estos días. Yo he tenido algún problemita que otro a la hora de preparar esta entrada. Nada que un par de horas de cabezazos en la pared no solucionen… ;-)</p>
</blockquote>

  </article>
  
	
    <div class="sharing">
  
  <div class="kcy_karmacracy_widget_h_ID" style="display:inline"></div>
  
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://javimoreno.me/blog/2013/05/22/helios-iii-piratas-y-bucaneros/" data-via="" data-counturl="http://javimoreno.me/blog/2013/05/22/helios-iii-piratas-y-bucaneros/" >Tweet</a>
  
  
  
</div>

  
  <p class="meta">
    
      <a class="navigation-link-left" href="/blog/2013/05/21/mama-salgo-en-un-podcast/" title="Previous Post: Mamá, Salgo en Un Podcast!">&laquo; Mamá, Salgo en Un Podcast!</a>
    
    
      <a class="navigation-link-right" href="/blog/2013/07/06/markdown/" title="Next Post: Markdown">Markdown &raquo;</a>
    
  </p>
	<div style="clear: both;"></div>
	
  <comments class="post-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
    var disqus_shortname = 'eloctoblog';
    
      
      // var disqus_developer = 1;
      var disqus_identifier = 'http://javimoreno.me/blog/2013/05/22/helios-iii-piratas-y-bucaneros/';
      var disqus_url = 'http://javimoreno.me/blog/2013/05/22/helios-iii-piratas-y-bucaneros/';
      var disqus_script = 'embed.js';
    
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </comments>
	

</div>

      </div>
    </div>

    <footer class="site-footer">
	
  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>♟ Javi Moreno</li>
          <li><a href="mailto:javi@javimoreno.me">javi@javimoreno.me</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jmoreno">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">jmoreno</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/jmoreno78">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">jmoreno78</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">En este blog encontraras cosas de iOS, Ruby on Rails, Padrino, reflexiones informáticas y hasta algo de bricolaje.
</p>
      </div>
    </div>

  </div>

</footer>

		
		
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


		  
  <script defer="defer" src="http://rodney.karmacracy.com/widget-3.0/?id=ID&button=1&display=right&show-tooltip=0"></script>
  


  </body>

</html>
