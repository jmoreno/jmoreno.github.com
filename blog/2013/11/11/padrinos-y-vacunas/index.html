<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Padrinos y vacunas</title>
  <meta name="description" content="Puede que no haya ido a donde quería ir, pero creo que he terminado donde tenía que estar.
" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="canonical" href="http://javimoreno.es/blog/2013/11/11/padrinos-y-vacunas/">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
  <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href='http://fonts.googleapis.com/css?family=Sanchez:400italic,400' rel='stylesheet' type='text/css'>
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="http://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
	
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38448478-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>
  <body itemscope itemtype="http://schema.org/Article">
	 <!-- header start -->

<!-- header end -->
    
    <main class="content" role="main">
      <article class="post">
        <div class="noarticleimage">
          <div class="post-meta">
					 
				  	<h1 class="post-title">Padrinos y vacunas</h1>
				  	 
          </div>
        </div>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4>Javi</h4>
              <p class="bio"></p>
              <hr>
              <p class="published"><i class="fa fa-calendar"></i><time datetime="2013-11-11 01:31"> 11 de noviembre de 2013</time></p>
              <p class="published"><i class="fa fa-clock-o"></i>  
              
              
              8 minutos
              
              de lectura
              </p>
            </section>
          </div>
        </div>
        <section class="post-content">
          <a name="topofpage"></a>
          <blockquote>
<p>Le haré una oferta que no podrá rechazar.</p>

<p><strong>Vito Corleone,</strong> <em>El Padrino</em></p>
</blockquote>

<p>En la misma película de la que he sacado esta cita se dice que los italianos piensan que el mundo es tan duro que hay que tener dos padres y por eso todos tienen un padrino. Quizá esto es lo que pensaron los desarrolladores del nuevo framework del que me he hecho fan, Padrino, por que el nombre le viene que ni pintado. </p>

<!--more-->

<p>Creo que mi búsqueda del backend perfecto empieza a ser preocupante y enfermiza. Vaya por delante que lo que yo busco es algo que me sirva para aplicaciones móviles, que pueda tener una pequeña interfaz web y que me deje ver la base de datos, que a mi me gusta mucho el SQL, para que nos vamos a engañar. </p>

<p>Ruby on Rails siempre me ha parecido una buena opción ya que es relativamente sencillo y con pocos pasos puedes tener mucho del desarrollo hecho. Si a eso le añades la versatilidad que tiene para mostrar los datos en HTML, XML o json tienes un gran complemento para dispositivos móviles. Sin embargo reconozco que para devolver un pequeño json no es necesario montar el pifostio que se monta con Rails. </p>

<p>En el otro extremo está Sinatra. Es sencillo, mucho más orientado a montar API&#39;s pero también te permite crear interfaces. La principal ventaja es que reduce a la mínima expresión lo que hay que escribir para que un servicio funcione. Sin embargo, puede llegar un momento en el que te canses de tanta sencillez y manualidad. </p>

<p>Padrino está justo en el medio de Rails y Sinatra. Esta construido sobre Sinatra pero incorpora utilidades que hacen más eficiente el desarrollo. Sólo una curiosidad, este post hacia bastante tiempo que pensaba escribirlo. Incialmente iba a hacerlo en Rails (hace año y pico), luego pensé en hacerlo en Sinatra (hace meses). Descubrí Padrino la semana pasada y aquí esta terminado. De la noche a la mañana he encontrado el framework que mejor se adapta a mis necesidades particulares. </p>

<p>Bueno, después del coñazo que he soltado vamos a ver si hacemos algo más interesante como, por ejemplo, resolver uno de los problemas más graves de la paternidad: saber que vacuna le toca a tu hijo/a en la próxima revisión.</p>

<h2>Calendario de vacunaciones.</h2>

<p>Por sí no lo sabéis, el calendario de vacunación infantil se basa en recomendaciones de la OMS que el Ministerio de Sanidad en colaboración con la Asociación Nacional de Pediatría estudia y presenta para que, posteriormente, las consejerías de sanidad de cada comunidad autónoma organicen como les de la gana. Esto hace que en España haya 19 calendarios diferentes que, además, suelen cambiar cada tres cuatro años. </p>

<p>El objetivo de nuestra aplicación web será devolver un json con los 19 calendarios actualizados. Para ellos, nuestra aplicación necesitará de un panel de administración con el que actualizáremos las cinco tablas que forman el modelo de datos. </p>

<p><img src="http://javimoreno.es/assets/photos/2013/diagram.png" alt=""></p>

<p>No voy a entrar en muchos detalles sobre el modelo. La primera tabla es la de países, inicialmente solo esta España pero creo que el modelo es extensible a cualquier país. Un país puede tener varios calendarios... como en España, que es una locura. Cada calendario tendrá una serie de eventos y cada evento tendrá, entre otros datos, una edad, una vacuna. Edades y Vacunas también son entidades del modelo de datos.</p>

<h3>Creación del proyecto</h3>

<p>Siguiendo la estela de Rails, Padrino tiene generadores que nos vendrán muy bien en diferentes fases del desarrollo. El primero que utilizaremos es el que permite crear el proyecto. </p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>padrino g project VacScheduler <span class="nt">-t</span> shoulda <span class="nt">-e</span> haml <span class="nt">-c</span> sass <span class="nt">-s</span> jquery <span class="nt">-d</span> activerecord <span class="nt">-b</span></code></pre></figure>

<p>La mejor forma de saber que significan todos estos términos es mirar la <a href="http://www.padrinorb.com/guides/generators">documentación de Padrino sobre los generadores</a>. Yo he puesto todo esto, no porque sea un listillo, sino porque para hacer está aplicación me he fusilado el <a href="http://www.padrinorb.com/guides/blog-tutorial">tutorial sobre como hacer un blog</a>.<br>
Basicamente, hemos creado un proyecto llamado VacScheduler que usa shoulda para el testing, haml para el renderizado de las páginas, sass para los estilos, jquery para la parte de scripting y activerecord para el orm. Además, cuando termine la creación del proyecto, forzaremos una instalación de las gemas que nos faltan con Bundle.</p>

<h3>Creación del panel de administración (esto hará las delicias de más de uno)</h3>

<p>Una gran diferencia con respecto a Rails es que, en Padrino han pensado que la existencia de un grupo de usuarios encargados de mantener las tablas que forman el modelo de la aplicación es un escenario lo suficientemente habitual como para crear una funcionalidad de Administración. A nosotros esto nos viene genial porque lo que queremos es tener una aplicación que devuelva una versión actualizada de los diferentes calendarios de vacunación y para actualizar esos datos tendremos a un usuario responsable de dicho mantenimiento. Las instrucciones para crear el panel de administración son las siguientes:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>padrino g admin <span class="nt">--theme</span> warehouse
<span class="nv">$ </span>bundle install

<span class="nv">$ </span>padrino rake ar:create
<span class="nv">$ </span>padrino rake ar:migrate
<span class="nv">$ </span>padrino rake seed</code></pre></figure>

<p>Este último paso nos pedirá un correo electrónico y una contraseña para poder acceder al panel de administración. Si después de hacer esto, arrancamos la aplicación podremos ver el bonito panel de administración.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>padrino start</code></pre></figure>

<h3>Creación de los modelos</h3>

<p>Si estuviéramos en Rails, generaríamos un scaffold. Padrino no tiene scaffold... o si? igual nos llevamos una sorpresa más adelante.<br>
De momento vamos a crear los modelos de las cinco tablas que forman nuestro modelo de datos.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>padrino g model age short_name:string name:string months:integer <span class="nt">-a</span> app
<span class="nv">$ </span>padrino g model calendar name:string country_id:integer <span class="nt">-a</span> app
<span class="nv">$ </span>padrino g model country name:string <span class="nt">-a</span> app
<span class="nv">$ </span>padrino g model event notes:text calendar_id:integer age_id:integer vaccine_id:integer <span class="nt">-a</span> app
<span class="nv">$ </span>padrino g model vaccine short_name:string name:string description:text link_info:string <span class="nt">-a</span> app</code></pre></figure>

<p>y hacemos la migración correspondiente para crear las entidades en la base de datos:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>padrino rake ar:migrate</code></pre></figure>

<h3>Modificación de los modelos para incluir las relaciones y validaciones</h3>

<p>Sobre los modelos que nos ha creado Padrino, hacemos las modificaciones oportunas para indicar las relaciones entre las entidades así como los campos que son obligatorios:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Age</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">has_many</span> <span class="ss">:events</span>
    <span class="n">validates_presence_of</span> <span class="ss">:short_name</span>
    <span class="n">validates_presence_of</span> <span class="ss">:name</span>
    <span class="n">validates_presence_of</span> <span class="ss">:months</span>
<span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Calendar</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">has_many</span> <span class="ss">:events</span>
    <span class="n">belongs_to</span> <span class="ss">:country</span>
    <span class="n">validates_presence_of</span> <span class="ss">:name</span>
<span class="k">end</span></code></pre></figure>
    

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Country</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">has_many</span> <span class="ss">:calendars</span>
    <span class="n">validates_presence_of</span> <span class="ss">:name</span>
<span class="k">end</span></code></pre></figure>
    

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">belongs_to</span> <span class="ss">:calendar</span>
    <span class="n">belongs_to</span> <span class="ss">:age</span>
    <span class="n">belongs_to</span> <span class="ss">:vaccine</span>
<span class="k">end</span></code></pre></figure>
    

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Vaccine</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">has_many</span> <span class="ss">:events</span>
    <span class="n">validates_presence_of</span> <span class="ss">:short_name</span>
    <span class="n">validates_presence_of</span> <span class="ss">:name</span>
<span class="k">end</span></code></pre></figure>

<h3>Creación de los paneles de administración de cada uno de los modelos anteriores</h3>

<p>Esto es lo que me ha ganado de Padrino. Las admin_page son unas pantallas de mantenimiento de datos semejantes a las creadas al hacer un scaffold de Rails pero vinculadas al panel de administración. Es decir, que solo serán visibles si estás autenticado en el sistema. Parece una chorrada, pero para hacer esto en Rails hay que picar un poquito.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>padrino g admin_page age
<span class="nv">$ </span>padrino g admin_page calendar
<span class="nv">$ </span>padrino g admin_page country
<span class="nv">$ </span>padrino g admin_page event
<span class="nv">$ </span>padrino g admin_page vaccine</code></pre></figure>

<p>Cuando refresquemos, veremos algo tan bonito como esto:</p>

<p><img src="http://javimoreno.es/assets/photos/2013/padrino-admin-1.png" alt=""></p>

<p><img src="http://javimoreno.es/assets/photos/2013/padrino-admin-2.png" alt=""></p>

<p><img src="http://javimoreno.es/assets/photos/2013/padrino-admin-3.png" alt=""></p>

<h3>Un JSON con todos los calendarios.</h3>

<p>El objetivo de la aplicación es enviar un JSON con la versión más actual de todos y cada uno de los calendarios para que una aplicación móvil refresque su base de datos y pueda informar a sus usuarios de cuales son las próximas vacunas que tienen que poner a sus criaturas.<br>
Ahora es cuando nos aprovechamos de que Padrino está montado sobre Sinatra y escribimos el siguiente trozo de código en app.rb:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
    <span class="no">Country</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_json</span><span class="p">(</span><span class="ss">:include</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:calendars</span> <span class="o">=&gt;</span> <span class="p">{</span>
                            <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:events</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="p">[</span>
                                    <span class="p">{</span> <span class="ss">:vaccine</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:short_name</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:link_info</span><span class="p">]}},</span> 
                                    <span class="p">{</span> <span class="ss">:age</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:months</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:short_name</span><span class="p">]}}],</span>
                                <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="ss">:notes</span><span class="p">}},</span>
                            <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">]</span> <span class="p">}},</span> 
                        <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">])</span>

<span class="k">end</span></code></pre></figure>

<p>Y listo, con este <em>sencillo</em> fragmento de código toda la funcionalidad <em>publica</em> de nuestra aplicación web está construida. Ya podemos llamar desde la aplicación.</p>

<p>Si queréis echar un vistazo, en Heroku (como no) está instalada está misma aplicación: <a href="http://vacscheduler.herokuapp.com">VacScheduler</a>. He tenido algunos problemitas con la codificación en la base de datos así que, si no lo he arreglado antes, veréis algunos <em>código extraños</em> donde debería haber tildes.</p>

<p>El código fuente de dicha aplicación lo podéis ver en <a href="https://github.com/jmoreno/VacScheduler">GitHub</a>.</p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Padrinos+y+vacunas&amp;url=http://javimoreno.es/blog/2013/11/11/padrinos-y-vacunas/"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
              
                <a class="icon-facebook" href="//www.facebook.com/sharer.php?t=Padrinos+y+vacunas&amp;u=http://javimoreno.es/blog/2013/11/11/padrinos-y-vacunas/"
                  onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;">
                <i class="fa fa-facebook"></i><span class="hidden">facebook</span>
                </a>
              
            
              
                <a class="icon-linkedin" href="//www.linkedin.com/shareArticle?mini=true&title=Padrinos+y+vacunas&amp;url=http://javimoreno.es/blog/2013/11/11/padrinos-y-vacunas/"
                  onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;">
                <i class="fa fa-linkedin"></i><span class="hidden">linkedin</span>
                </a>
              
            
          </section>
          <nav class="post-pagination-next" role="navigation">
            
              <a class="next" href="/blog/2014/01/26/workflows-de-editorial-para-octopress/">&larr; Workflows de Editorial para Octopress</a>
            
          </nav>
          <nav class="post-pagination-previous" role="navigation">
            
              <a class="previous" href="/blog/2013/10/05/adios-keynote/">Adios Keynote, hola reveal.js &rarr;</a>
            
          </nav>
          <nav class="post-pagination-clear" role="navigation">
          </nav>
				  
        </footer>
      </article>
    </main>
        <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/cover-rails.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">Javi Moreno</h1>
        <h2 class="blog-description">Puede que no haya ido a donde quería ir, pero creo que he terminado donde tenía que estar.
</h2>
        <a href="/" class="btn">Ir a la página principal</a>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>


		<script type="text/javascript">
	var url_repository = "https://github.com/jmoreno/jmoreno.github.io"
	var url_issue = "https://github.com/jmoreno/jmoreno.github.io/issues/" + ''
	var api_comments_url = "https://api.github.com/repos/jmoreno/jmoreno.github.io/issues/" + '' + "/comments"
	$(document).ready(function () {
	    $.ajax(api_comments_url, {
	        headers: {Accept: "application/vnd.github.v3.html+json"},
	        dataType: "json",
	        success: function(comments) {
	            $("comments").append("<hr><h2 class='description'>Los comentarios de este blog se publican en su <a href='" + url_repository + "'>repositorio de Github</a>. Puedes escribir el tuyo <a href='" + url_issue + "'>aquí</a>.</h2>");
	            $.each(comments, function(i, comment) {
	
	                var date = new Date(comment.created_at);
	
	                var t = "<blockquote id='gh-comment'>";
	                t += "<img src='" + comment.user.avatar_url + "' width='24px'>";
	                t += "<b><a href='" + comment.user.html_url + "'> " + comment.user.login + "</a></b>";
	                t += " publicó este comentario el ";
	                t += "<em>" + date.toLocaleDateString() + " a las " + date.toLocaleTimeString() + "</em>";
	                t += "<div id='gh-comment-hr'></div>";
	                t += comment.body_html;
	                t += "</blockquote>";
	                $("comments").append(t);
	            });
	        },
	        error: function() {
	            $("comments").append("<hr><h2 class='description'>Aparentemente este post no admite comentarios...</h2>");
	        }
	    });
	});
</script>
<noscript>Si quieres ver los comentarios tendrás que activar Javascript.
</noscript>
  </body>
</html>
